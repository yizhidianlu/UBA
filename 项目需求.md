# 「不败之地」估值触发投资系统 —— 网站 / Python 程序项目需求文档（PRD + 技术要求）

> 目标：把文件里的核心逻辑落地成一个可执行系统：  
> **用“能力圈股票池 + PB请客价触发 + 四动作流程（买/加/持/卖）+ 风险与结构复盘”** 来替代“猜涨跌”。

---

## 1. 项目概述

### 1.1 产品定位
一个面向长期价值投资的工具，帮助用户：
- 建立并维护「能力圈股票池」
- 为每只股票设定「PB 请客价 / 不败价」触发区间
- 触发后按「四动作流程」执行并记录（买入/加仓/持有/卖出）
- 以“交易结构分布”（大赚/小赚/持平/小亏/大亏）进行长期复盘
- 严格执行风控：**单一股票仓位上限（默认 10%）**、成本与纪律约束

### 1.2 目标用户
- 有长期投资倾向的个人投资者
- 需要从“看K线冲动交易”转向“估值触发 + 纪律执行”的用户
- 希望建立可复用流程和复盘体系的用户

### 1.3 非目标（本期不做）
- 不做短线/做T/盘口策略
- 不提供“个股推荐”
- 不做预测模型（涨跌预测、择时预测）

---

## 2. 核心方法论抽象（系统化表达）

### 2.1 核心对象
- **股票（Asset）**：代码、市场、行业、币种、财报口径
- **能力圈评分（CircleOfCompetence）**：用户对公司理解程度的主观评分与备注
- **估值指标（Valuation）**：PB 为主（可扩展 PE/PS/股息率）
- **触发器（Trigger）**：PB 进入用户设定阈值区间即触发
- **动作（Action）**：Buy / Add / Hold / Sell（四动作）
- **仓位与风控（Risk）**：单票上限、最大回撤阈值、现金比例、分仓规则
- **交易日志（Journal）**：每次动作的理由、证据、情绪、执行是否符合规则
- **结构复盘（Structure Review）**：收益分布而非“单笔对错”

### 2.2 核心流程（SOP）
1. 建立股票池（50~100 只，能力圈内）
2. 为每只股票设置 PB 阈值：
   - 请客价（Buy Trigger）
   - 压倒性优势价（Add Trigger，可选）
   - 目标价/退出价（Sell Trigger，可选）
3. 系统每日/定时拉取 PB：
   - 未触发：仅监控
   - 触发：生成“行动建议卡”（Buy/Add/Hold/Sell）
4. 用户确认后执行动作，并记录日志
5. 定期复盘：
   - 执行纪律（是否按规则）
   - 交易结构（大赚/小赚/持平/小亏/大亏）
   - 成本（换手、手续费、滑点）对收益侵蚀

---

## 3. 功能需求（MVP -> V1 -> V2）

### 3.1 MVP（最小可用）
#### 3.1.1 股票池管理
- 添加/删除股票：支持 A 股 / 港股（可扩展美股）
- 字段：
  - code（如 600519.SH / 0700.HK）
  - name
  - market
  - 行业/标签
  - 能力圈评分（1~5）
  - 备注（护城河/理解要点）

#### 3.1.2 PB 数据获取与存储
- 定时拉取最新 PB（每日一次即可）
- 存储历史 PB（用于估值分位、回测、图表）
- 数据字段：
  - date
  - pb
  - price（可选）
  - book_value_per_share（可选，若源支持）
  - data_source

> 说明：数据源在需求层不绑定具体提供商，但必须支持“可追溯”和“容错”。

#### 3.1.3 估值触发器（请客价）
- 每只股票配置：
  - buy_pb_threshold（如 PB <= 1.2）
  - add_pb_threshold（可选，如 PB <= 1.0）
  - sell_pb_threshold（可选，如 PB >= 3.0）
- 触发规则：
  - 当日 PB <= buy_threshold：触发 Buy 建议
  - 当持仓存在且 PB <= add_threshold：触发 Add 建议
  - 当持仓存在且 PB >= sell_threshold：触发 Sell 建议
- 触发后生成一条“待办/信号（Signal）”

#### 3.1.4 四动作执行与记录
- 用户在信号卡中选择：
  - Buy / Add / Hold / Sell
- 记录字段：
  - action_type
  - action_date
  - planned_position_pct（计划仓位）
  - executed_position_pct（实际仓位）
  - price（可选）
  - reason（必填：为什么符合规则）
  - emotion（可选：恐惧/贪婪/冲动等）
  - rule_compliance（是否合规：Yes/No + 原因）

#### 3.1.5 风控约束（硬规则）
- 单票最大仓位：默认 10%（用户可配置）
- 买入/加仓时，如果超出上限：
  - 前端提示并阻止提交（默认）
  - 或允许“强制执行”，但必须填写原因（可配置）
- 交易成本字段（可选录入）：手续费/印花税/滑点

#### 3.1.6 仪表盘（最少三块）
- 监控列表：PB、阈值、距离触发差值
- 今日信号：触发 Buy/Add/Sell 的列表
- 持仓概览：仓位占比、触发状态

---

### 3.2 V1（可用性与复盘增强）
#### 3.2.1 PB 分位与“稀缺便宜”提示
- 计算近 N 年 PB 分位（例如 5 年/10 年）
- 信号卡显示：
  - 当前 PB
  - 历史分位（如 10%）
  - 是否处于“历史稀缺区间”（用户定义阈值，如 <= 15%）

#### 3.2.2 结构复盘（核心差异化）
- 自动把每笔交易结果归类：
  - 大赚/小赚/持平/小亏/大亏（阈值可配置，如 ±3%、±10%）
- 输出“结构得分”：
  - 统计次数与贡献
  - 识别是否存在“多次小赚 + 一次大亏”的致命模式
- 纪律统计：
  - 合规率
  - 违规原因 TOP（追涨、超仓、无理由交易等）

#### 3.2.3 通知系统
- 触发信号通知：
  - Email / Telegram / 企业微信 / Web Push（实现选其一）
- 通知内容不含推荐，只含：
  - “XXX PB 达到请客价阈值，建议进入四动作决策流程”

---

### 3.3 V2（更强的“流程化执行”）
- 多账户/多组合（不同策略、不同风险偏好）
- 回测（仅回测“PB触发 + 四动作规则”，不做预测）
- 规则模板：
  - 保守型：更低阈值、更严格分仓
  - 平衡型：默认
  - 进取型：允许更高仓位上限但强化止损/退出纪律
- “投资备忘录”与证据库：上传年报摘要、研究笔记，关联到股票与动作

---

## 4. 页面与交互设计（Web）

### 4.1 页面清单
1. 登录/账户设置（可选：本地单机版不需要）
2. 股票池（Watchlist）
3. 股票详情页
   - PB 时间序列图
   - 阈值配置
   - 信号历史
   - 动作日志
4. 今日信号（Signals）
5. 组合/持仓（Portfolio）
6. 复盘（Review）
   - 结构分布
   - 纪律统计
   - 成本分析

### 4.2 关键交互：信号卡（Signal Card）
信号卡必须回答三个问题：
- 发生了什么：PB 到达哪个阈值
- 为什么重要：历史分位/稀缺程度
- 下一步怎么做：进入四动作选择 + 风控校验 + 日志必填

---

## 5. Python 程序形态（CLI/桌面/服务）

### 5.1 三种形态（任选其一作为首发）
A) **CLI 工具（最快落地）**
- `watchlist add/list/remove`
- `fetch pb`
- `signals today`
- `action log`
- `review report`

B) **本地桌面（Streamlit）**
- 快速做 dashboard + 表单 + 图表
- 单机 SQLite 数据库

C) **Web 服务（FastAPI + 前端）**
- 标准架构，便于扩展与部署

> 推荐路径：MVP 用 Streamlit 或 FastAPI，数据用 SQLite；后续可升级 Postgres。

---

## 6. 数据与模型设计（最小结构）

### 6.1 数据表（示例）
- assets
  - id, code, name, market, tags, competence_score, notes
- thresholds
  - asset_id, buy_pb, add_pb, sell_pb, updated_at
- valuations
  - asset_id, date, pb, price, source
- portfolio_positions
  - asset_id, position_pct, avg_cost, updated_at
- signals
  - id, asset_id, date, signal_type(BUY/ADD/SELL), pb, triggered_threshold, status(OPEN/DONE/IGNORED)
- actions
  - id, asset_id, date, action_type, planned_position_pct, executed_position_pct, price, reason, emotion, compliance, compliance_note
- costs
  - action_id, fee, tax, slippage

---

## 7. 规则引擎（必须清晰可解释）

### 7.1 规则优先级
1. 风控规则（硬约束）
2. 信号触发规则（PB 阈值）
3. 提示规则（分位、稀缺区间）
4. 复盘归因规则（结构分类）

### 7.2 规则可解释性（强制要求）
每条信号必须生成可读解释文本，例如：
- “当前 PB=1.05 ≤ 请客价 1.20，触发 BUY 信号；近10年分位=12%，属于稀缺低估区间。”

---

## 8. 非功能需求（NFR）

### 8.1 可追溯与可靠性
- 每条 PB 数据要记录来源与时间
- 拉取失败需重试与告警（本地提示/日志）
- 支持离线浏览历史数据与日志

### 8.2 安全与隐私
- 本地单机版默认数据不出设备
- Web 版需：
  - 密码哈希存储
  - 基础鉴权（JWT/Session）
  - 数据隔离（多用户）

### 8.3 性能
- 日频数据量很小，重点是稳定与可解释
- 图表渲染：单股票 10 年日频仍可流畅（可按周/月采样）

---

## 9. 验收标准（可测试）

### 9.1 MVP 验收
- 能添加 20+ 股票并保存
- 能拉取并展示 PB（至少最近 1 年）
- 能配置请客价阈值并生成信号
- 能在信号卡完成四动作记录（reason 必填）
- 单票超仓会被阻止或强制理由
- 仪表盘能展示：
  - 今日触发清单
  - 距离阈值差值
  - 持仓与仓位占比

### 9.2 V1 验收
- 分位计算正确且可视化
- 结构复盘能输出分类统计与合规率
- 通知在触发当日能送达（至少一种渠道）

---

## 10. 建议技术栈（可选）

### 10.1 快速版（推荐）
- Python: Streamlit + Pandas + SQLite
- 定时任务：APScheduler / cron
- 图表：Plotly / Matplotlib

### 10.2 标准 Web 版
- 后端：FastAPI + SQLAlchemy + SQLite/Postgres
- 前端：Next.js / React（可选）
- 任务：Celery/Redis 或 cron
- 部署：Docker

---

## 11. 里程碑计划（按交付件）
- M1：数据模型 + 股票池 + PB 拉取入库
- M2：阈值配置 + 信号生成 + 今日信号页
- M3：四动作日志 + 风控校验 + 持仓页
- M4：分位/稀缺提示 + 结构复盘报表（V1）

---

## 12. 风险与边界说明
- PB 在不同行业/会计口径下意义不同：系统只提供“触发与纪律框架”，不替用户判断护城河真假。
- 数据源可能存在缺失/延迟：必须在 UI 中提示“数据更新时间”与“缺失处理策略”。
- 不输出投资建议：只输出“是否满足用户自定义规则”，并要求用户填写理由完成闭环。

---

## 13. 输出物清单
- 项目 README（安装/运行/数据源配置）
- 数据库 schema 与迁移脚本（如采用 ORM）
- 规则引擎模块（signals, risk, review）
- 前端页面或 Streamlit 页面
- 示例数据与演示流程（demo watchlist）

---
